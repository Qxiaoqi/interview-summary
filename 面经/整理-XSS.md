# XSS：
就是攻击者注入恶意代码，然后浏览器执行，能获取一些敏感信息。

## 分类：

1、反射型（非持久性，因为代码注入产生的是动态生成的页面） （存在URL里，服务端漏洞）

攻击者，通过电子邮件等方式，将包含注入脚本的恶意链接发送给用户，脚本被传输到服务器上，然后服务器将注入脚本反射到用户浏览器上，在浏览器上执行脚本。

比如：
```html
<a href="http://localhost:8001?query=<script>alert('xss')</script>">恶意链接</alert>
```

注入的脚本被当作搜索的关键词，脚本将被当作搜索关键词嵌入，当用户得到搜索结果页面时，脚本也被执行。但实际上，现在浏览器的安全措施都比较好，有一个响应头叫X-XSS-Protection，默认设置为1，启用XSS过滤，检测到脚本攻击，浏览器将删除不安全的部分。0是禁止XSS过滤。

有一个非常有意思的情况是，默认值为1其实并不安全，首先是可以绕过的。其次，如果攻击者构造一脚本引入个安全的文件名，比如
```html
<a href="http://localhost:8001?query=<script src='https://cdn.bootcss.com/jquery/3.4.1/jquery.js'></script>">恶意链接</alert>
```

而你的页面中也引入了该文件，那么默认情况下浏览器会将其删除，造成页面无法正常渲染的情况。


2、存储型（持久性） （存在数据库里，服务端漏洞）

常见的场景是，攻击者在论坛中评论，其中包含恶意代码，发表后，内容被存在服务端。当其他用户浏览该评论的时候，浏览器会执行这段恶意代码。

备注：同源策略的情况下，POST请求实际是会发出去的（服务端会收到请求），只是被浏览器拦截。


3、DOM型 （只是发生在客户端）

通过恶意代码修改DOM结构，比如页面添加跳转链接，输入url。可构造特殊语句，比如'' onclick=alert(/xss/)。并没有和服务端交互，但是恶意代码依旧被插入到了DOM中，用户点击这个链接，就会执行恶意代码。

但是攻击者到底如何攻击的？全程都是用户自己操作，如何触发？

## 要素：
1、攻击者提交提交恶意代码

2、浏览器执行

## 预防：
我们就能根据要素去选择预防策略

### 要素一
#### 1、输入过滤、转义：前端过滤，提交到后端

不是很合适，攻击者可以绕过。所以一般服务端进行转义。

但是这个也有一个缺陷，
* 如果是HTML拼接页面，那可以直接正常显示（HTML解析文档时一般分为HTML解析，URL解析，JS解析），
* 但如果是前端渲染的，拿到这个数据之后，就只能显示转义之后的样子，不能用于展示。

转义如下：

```js
// 在 vuejs 中，如果输入带 script 标签的内容，会直接过滤掉
const decodingMap = {
  '&lt;': '<',
  '&gt;': '>',
  '&quot;': '"',
  '&#x27;': "'",
  '&amp;': '&',
  '&#10;': '\n'
}
```

### 要素二

#### 2、纯前端渲染
如果不需要性能要求过高，或者SEO问题啥的，或者不需要拼接HTML吧，不用服务端渲染的话，可以使用。前端可以设置内容显示的文本。除此之外，前端渲染还需要避免DOM型XSS漏洞，比如之前说的a标签的href属性中的javascript: 开头

#### 3、输出转义
转义这部分比较复杂，情况比较多，如果必要的话，尽量用完善的库。常用的模板引擎比如pug、ejs等，对HTML会进行转义，但并不完善。举个例子：

比如一个a标签，里面的href通过url参数获取。攻击者可以构造 `javascript: ...` 开头的语句，这样
```html
<a href="<%= escapeHTML(getParameter("redirect_to"))%>">
```
能执行的原因涉及到浏览器解析HTML文档的原理，解析主要有三个过程，HTML解析，JS解析，URL解析。那之前举的a标签的href里面解析顺序就是HTML解析，URL解析，JS解析。如果只是单纯的把HTML转义，比如把 引号 转义成了HTML实体，当浏览器解析的时候，在HTML解析的部分会将转义的 HTML实体编码 解析成 引号，所以会造成XSS。

[解释](https://security.yirendai.com/news/share/26)

解决方案：

A. 可以JavaScript Unicode编码 + HTML编码，原因是因为 JavaScript解析 标识符会被正常解析，而引号、括号这些的时候会被解析成文本，所以代码不闭合，恶意代码就无法被执行。

B. 白名单，href里面只允许http、https协议，其它的一概跳报错页面。

所以说，HTML编码很复杂，不同的上下文情况要使用不同的转义规则。比如：

* HTML 标签内文字内容：HTML实体编码
* HTML input value 标签属性：属性编码，严格校验不安全变量，比如id
* CSS style属性：CSS编码，将括号之类的
* URL：URL编码， 转成%之类的
* JavaScript内联代码块：Unicode编码

[等等](https://juejin.im/entry/58a598dc570c35006b5cd6b4)

#### 4、代码编写

这一部分一般是由于前端代码不够严谨，一般多是DOM型XSS。比如innerHTML。

解决：

* 利用模板引擎（比如ejs中的<%= data %>）
* 尽量避免拼接内联事件，比如onClick，JavaScript通过addEventlistener监听较安全
* 采用比较成熟的渲染框架
等等

### 其它

#### HttpOnly

除上面所说两方面，很多XSS是为了拿到Cookie，因此设置HttpOnly可以防止XSS发生后，攻击者拿到Cookie。

#### 输入长度控制

增加攻击难度

#### CSP策略

浏览器做的一些安全策略。CSP实质是白名单，开发者明确告诉浏览器哪些外部资源可以加载和执行。我们只需要配置规则，如何拦截是由浏览器自己实现的。我们可以通过这种方式来尽量减少 XSS 攻击。

通常可以通过两种方式来开启 CSP：

* 设置 HTTP Header 中的 Content-Security-Policy
* 设置 meta 标签的方式 <meta http-equiv="Content-Security-Policy">

* 只允许加载本站资源
Content-Security-Policy: default-src ‘self’

* 图片只允许加载 HTTPS 协议
Content-Security-Policy: img-src https://*

* 允许加载任何来源框架
Content-Security-Policy: child-src 'none'

## XSS检测

1. 手动检测，使用通用的XSS攻击字符串，在所有输入框，URL部分手动测试

2. 扫描工具